# Copilot Instructions for Habitat Builder Repository

## Repository Overview
This is the Habitat Builder repository - a public SaaS infrastructure for users of the Habitat automation framework. It provides web UI and REST APIs for the `hab` client.

## Repository Structure
```
/
├── components/
│   ├── artifactory-client/         # Artifactory API client
│   ├── builder-api/                # Main REST API service
│   ├── builder-api-proxy/          # API proxy service
│   ├── builder-core/               # Core shared functionality
│   ├── builder-datastore/          # Data storage configuration
│   ├── builder-db/                 # Database layer
│   ├── builder-memcached/          # Caching configuration
│   ├── builder-minio/              # Object storage
│   ├── builder-protocol/           # Protocol buffers definitions
│   ├── builder-web/                # Frontend web application (TypeScript/Angular)
│   ├── github-api-client/          # GitHub API integration
│   └── oauth-client/               # OAuth authentication client
├── docs/                           # Documentation
├── support/                        # Support scripts and configurations
├── test/                           # Test configurations and fixtures
├── tools/                          # Utility tools
├── terraform/                      # Infrastructure as code
└── target/                         # Rust build artifacts (generated)
```

## Critical File Modification Restrictions

### DO NOT MODIFY THE FOLLOWING FILES:
1. **Protobuf Code Generation Files**: Do not modify any files generated by `build.rs` scripts, particularly in `components/builder-protocol/src/message/` directory
2. **Build Artifacts**: Never modify files in the `target/` directory
3. **Generated Lock Files**: Do not manually edit `Cargo.lock`
4. **Auto-generated Protocol Files**: Any `.proto` generated files should not be manually modified

## MCP Server Integration

When a Jira ID is provided, use the **atlassian-mcp-server** MCP server to:
1. Fetch the Jira issue details
2. Read the story description and acceptance criteria
3. Understand the requirements thoroughly before implementation
4. Implement the task based on the Jira story requirements

## Testing Requirements

### Code Coverage Standards
- **Minimum code coverage**: 80%
- Always create comprehensive unit test cases for your implementation
- Run tests after implementation to ensure coverage meets standards
- Include both positive and negative test cases
- Test edge cases and error scenarios

### Test Files Location
- Unit tests should be placed in `tests/` directories within each component
- Integration tests go in the main `test/` directory
- Follow existing test patterns and naming conventions

## Pull Request Workflow

### Branch Creation and PR Process
1. **Branch Naming**: Use the Jira ID as the branch name (e.g., `JIRA-1234`)
2. **Create ai-assisted label**: Ensure the ai-assisted label exists in the repository:
   ```bash
   gh label create "ai-assisted" --color "9A4DFF" --description "Work completed with AI assistance following Progress AI policies" --force
   ```

3. **Use GitHub CLI for all Git operations**:
   ```bash
   # Create and switch to new branch
   gh repo clone habitat-sh/builder
   cd builder
   git checkout -b JIRA-1234
   
   # Make your changes and commit
   git add .
   git commit -m "JIRA-1234: Brief description of changes"
   
   # Push branch and create PR
   git push origin JIRA-1234
   gh pr create --title "JIRA-1234: Brief description" --body "$(cat pr_description.html)"
   ```

4. **PR Description Format**: Use HTML tags for formatting:
   ```html
   <h2>Summary</h2>
   <p>Brief summary of changes made</p>
   
   <h2>Changes Made</h2>
   <ul>
     <li>Change 1</li>
     <li>Change 2</li>
     <li>Change 3</li>
   </ul>
   
   <h2>Testing</h2>
   <p>Description of tests added and coverage achieved</p>
   
   <h2>Jira Issue</h2>
   <p>Implements requirements from JIRA-1234</p>
   
   <h2>AI Assistance</h2>
   <p>This work was completed with AI assistance following Progress AI policies</p>
   ```

5. **Add PR Labels**: Always add the required labels to the PR:
   ```bash
   gh pr edit --add-label "runtest:all:stable"
   gh pr edit --add-label "ai-assisted"
   ```

## Prompt-Based Development Workflow

### Step-by-Step Process
All tasks must be performed using a prompt-based approach with user confirmation at each step:

#### Step 1: Requirement Analysis
- Read and understand the Jira issue (if provided)
- Analyze the repository structure
- Identify affected components
- **Prompt**: "I've analyzed the requirements. The implementation will involve [components]. Summary: [brief summary]. Shall I proceed to the next step?"

#### Step 2: Planning and Design
- Create implementation plan
- Identify files to be modified/created
- Plan test strategy
- **Prompt**: "Implementation plan created. Will modify [files] and create tests in [locations]. Next step: Implementation. Continue?"

#### Step 3: Implementation
- Implement the required changes
- Follow Rust best practices and project conventions
- Ensure no prohibited files are modified
- **Prompt**: "Implementation completed. Modified [files]. Next step: Testing. Continue?"

#### Step 4: Testing
- Create comprehensive unit tests
- Run tests to ensure > 80% coverage
- Validate functionality
- **Prompt**: "Tests implemented with [coverage]% coverage. All tests passing. Next step: PR Creation. Continue?"

#### Step 5: PR Creation
- Create branch with Jira ID
- Commit changes with descriptive message
- Push to remote repository
- Create PR with HTML-formatted description
- Add required labels
- **Prompt**: "PR created successfully: [PR URL]. Next step: Update JIRA Ticket. Continue?"

#### Step 6: Update JIRA Ticket (Mandatory)
- Use atlassian-mcp-server to update the JIRA ticket
- Set customfield_11170 ("Does this Work Include AI Assisted Code?") to "Yes"
- Use correct field format: `{"customfield_11170": {"value": "Yes"}}`
- Verify the field update was successful
- **Prompt**: "JIRA ticket updated successfully with AI assistance field. Workflow complete. Any additional steps needed?"

### Ask for Continuation
After each step, always:
1. Provide a clear summary of what was accomplished
2. State what the next step will be
3. List remaining steps in the workflow
4. Ask: "Do you want to continue with the next step?"

## Development Environment Setup

### Prerequisites
- Rust toolchain (specified in `rust-toolchain` file)
- Docker for containerized services
- Node.js for frontend development
- PostgreSQL for database
- Redis/Memcached for caching

### Local Development
All tasks will be performed on the local repository. Use the following for setup:
- Follow instructions in `DEVELOPING.md`
- Use Docker Compose for local services
- Run `cargo test` for Rust components
- Run `npm test` for frontend components

## Code Quality Standards

### Rust Code Standards
- Follow Rust 2021 edition standards
- Use `rustfmt` for code formatting
- Address all `clippy` warnings
- Write comprehensive documentation
- Follow the existing project structure and patterns

### Frontend Code Standards
- Follow TypeScript best practices
- Use existing Angular patterns
- Maintain consistent styling
- Write unit tests for components

## Additional Guidelines

### Error Handling
- Use proper error handling patterns for Rust (`Result<T, E>`)
- Implement meaningful error messages
- Log errors appropriately

### Documentation
- Update relevant documentation when making changes
- Add inline code comments for complex logic
- Update README files if functionality changes

### Security Considerations
- Never commit sensitive information
- Follow OAuth and authentication patterns established in the codebase
- Validate all inputs and sanitize outputs

## Workflow Summary

1. **Analyze** → Read Jira issue and understand requirements
2. **Plan** → Create implementation strategy and identify files
3. **Implement** → Write code following project standards
4. **Test** → Create comprehensive tests (>80% coverage)
5. **Review** → Ensure no prohibited files modified
6. **PR** → Create branch, commit, push, and create PR with proper labels
7. **Update JIRA** → Set AI assistance field using atlassian-mcp-server (Mandatory)
8. **Validate** → Confirm all requirements met

Remember: Always ask for user confirmation before proceeding to the next step, and provide clear summaries of progress and remaining work.
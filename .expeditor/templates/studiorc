# This file (.expeditor/templates/studiorc) is concatenated onto .studiorc when
# .expeditor/scripts/verify/builder-api-functional.sh runs.  

cd /src || exit

# This should be the default in any ci environment (or any linux environment)
# However as of a couple weeks before adding this, it was not set in our buildkite agents
chmod 1777 /dev/shm

echo "--- Installing prerequisites"
hab pkg install core/postgresql96 --channel stable
hab pkg install core/openssl
hab pkg install core/node --binlink
hab pkg install core/coreutils
hab pkg binlink core/coreutils env -d /usr/bin
(
  # At the point studiorc is evaluated, our cwd is /
  cd /src/test/builder-api || exit
  npm install mocha
)

echo "--- Creating fake builder-github-app.pem"
hab pkg exec core/openssl openssl genrsa \
  -out /src/.secrets/builder-github-app.pem 2048

echo "--- Creating log directory"
mkdir -p logs
echo "--- Starting the supervisor"
if pgrep hab-sup >/dev/null 2>&1; then
  echo "Before attempting to start a hab-sup a hab-sup process was found, exiting"
  exit 1
fi
env HAB_FUNC_TEST=1 hab sup run >logs/sup.log 2>&1 &

until hab svc status >/dev/null 2>&1; do
  echo "waiting for hab sup to start"
  sleep 1
done

echo "--- Starting builder"

# This fixes the broken handlbars in stable builder with hab v2
hab pkg install habitat/builder-api --channel stable
cp /src/components/builder-api/habitat/config/config.toml $(hab pkg path habitat/builder-api)/config/

start-builder

while ! [ -f "/hab/svc/builder-api/files/builder-github-app.pem" ]; do
  echo "Waiting for builder-github-app.pem"
  ls /hab/svc/builder-api/files
  sleep 10
done

echo "--- Waiting for services to start"
while hab svc status | grep --quiet down; do
  echo "Waiting for services to start..."
  sleep 10
done

# lets put some data in the builder datastore and minio to verify migrations
cp /src/test/builder-api/fixtures/rcpd-20200401201905.pub /hab/cache/keys/
hab origin create rcpd -z bobo -u http://localhost:9636
env RUST_LOG=debug hab pkg upload /src/test/builder-api/fixtures/rcpd-testapp-0.1.0-20200401202136-x86_64-linux.hart --url http://localhost:9636 --auth bobo

# In most cases, these builds will be noise in the log files
# Redirect the output into a file that is automatically uploaded
# to buildkite so we can inspect if necessary
echo "--- Building changed builder components"

# NOTE: While building builder-api there is repeating error that can be
# recognized by "Crypto error: No revisions found for bldr". We might be able
# prevent it but things will self-correct and the script will continue.
echo "--- Building builder-api"
echo "Redirecting log output; See build artifact 'builder-api.build.log'"
build-builder api >logs/builder-api.build.log 2>&1

echo "--- Building builder-datastore"
echo "Redirecting log output; See build artifact 'builder-datastore.build.log'"
build-builder datastore >logs/builder-datastore.build.log 2>&1

echo "--- Building builder-minio"
echo "Redirecting log output; See build artifact 'builder-minio.build.log'"
build-builder minio >logs/builder-minio.build.log 2>&1
sleep 10

echo "--- Waiting for services to start"
while hab svc status | grep --quiet down; do
  echo "Waiting for services to start..."
  sleep 10
done

echo "--- Waiting for builder-github-app.pem to arrive"
while ! [ -f "/hab/svc/builder-api/files/builder-github-app.pem" ]; do
  echo "Waiting for builder-github-app.pem"
  ls /hab/svc/builder-api/files
  sleep 10
done

hab pkg install rcpd/testapp -u http://localhost:9636 --channel unstable --auth bobo || {
  echo "ERROR: Failed to install rcpd/testapp package"
  exit 1
}
hab pkg uninstall rcpd/testapp
hab pkg delete rcpd/testapp/0.1.0/20200401202136 -u http://localhost:9636 --auth bobo

echo "--- :mocha: Running tests"
test/builder-api/test.sh
# Explicitly exit with the tests status, as we're in a studio at this point
exit $?
